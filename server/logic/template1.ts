// const _ = require('lodash');
import * as _ from 'lodash';

const tpl = `
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">

<head>
  <title></title>
  <!--[if !mso]><!-- -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!--<![endif]-->
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style type="text/css">
    #outlook a {
      padding: 0;
    }

    .ReadMsgBody {
      width: 100%;
    }

    .ExternalClass {
      width: 100%;
    }

    .ExternalClass * {
      line-height: 100%;
    }

    body {
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }

    table,
    td {
      border-collapse: collapse;
      mso-table-lspace: 0pt;
      mso-table-rspace: 0pt;
    }

    img {
      border: 0;
      height: auto;
      line-height: 100%;
      outline: none;
      text-decoration: none;
      -ms-interpolation-mode: bicubic;
    }

    p {
      display: block;
      margin: 13px 0;
    }
  </style>
  <!--[if !mso]><!-->
  <style type="text/css">
    @media only screen and (max-width:480px) {
      @-ms-viewport {
        width: 320px;
      }
      @viewport {
        width: 320px;
      }
    }
  </style>
  <!--<![endif]-->
  <!--[if mso]><xml>  
  <o:OfficeDocumentSettings>    <o:AllowPNG/>    
  <o:PixelsPerInch>96</o:PixelsPerInch>  </o:OfficeDocumentSettings></xml><![endif]-->
  <!--[if lte mso 11]><style type="text/css">  .outlook-group-fix {    width:100% !important;  }</style><![endif]-->
  <!--[if !mso]><!-->
  <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet" type="text/css">
  <style type="text/css">
    @import url(https://fonts.googleapis.com/css?family=Ubuntu);
  </style>
  <!--<![endif]-->
  <style type="text/css">
    @media only screen and (min-width:480px) {
      .mj-column-per-33 {
        width: 33.333333333333336% !important;
      }
      .mj-column-per-100 {
        width: 100% !important;
      }
      .mj-column-per-60 {
        width: 60% !important;
      }
      .mj-column-per-40 {
        width: 40% !important;
      }
    }
  </style>
</head>

<body style="background: #FFFFFF;">
  <div class="mj-container" style="background-color:#FFFFFF;">
    <!--[if mso | IE]>      <table role="presentation" 
    border="0" cellpadding="0" cellspacing="0" width="600" 
    align="center" style="width:600px;">        <tr>          
    <td style="line-height:0px;font-size:0px;mso-line-height-rule:exactly;">      <![endif]-->
    <table role="presentation" cellpadding="0" cellspacing="0" 
    style="background:url(https://topolio.s3-eu-west-1.amazonaws.com/uploads/5acdd088d918a/1523457714.jpg) 
    top center / auto repeat;font-size:0px;width:100%;"
      border="0" background="https://topolio.s3-eu-west-1.amazonaws.com/uploads/5acdd088d918a/1523457714.jpg">
      <tbody>
        <tr>
          <td>
            <div style="margin:0px auto;max-width:600px;">
              <!--[if mso | IE]>      
              <v:rect xmlns:v="urn:schemas-microsoft-com:vml" 
              fill="true" stroke="false" style="width:600px;">        
              <v:fill origin="0.5, 0" position="0.5,0" type="tile" 
              src="https://topolio.s3-eu-west-1.amazonaws.com/uploads/5acdd088d918a/1523457714.jpg" />        
              <v:textbox style="mso-fit-shape-to-text:true" inset="0,0,0,0">      <![endif]-->
              <table role="presentation" cellpadding="0" cellspacing="0" 
              style="font-size:0px;width:100%;" align="center"
                border="0">
                <tbody>
                  <tr>
                    <td style="text-align:center;vertical-align:top;direction:ltr;font-size:0px;
                    padding:100px 0px 100px 0px;">
                      <!--[if mso | IE]>      <table role="presentation" 
                      border="0" cellpadding="0" cellspacing="0">        
                      <tr>          <td style="vertical-align:top;width:198px;">      <![endif]-->
                      <div class="mj-column-per-33 outlook-group-fix" 
                      style="vertical-align:top;display:inline-block;
                      direction:ltr;font-size:13px;text-align:left;width:100%;">
                        <table role="presentation" cellpadding="0" cellspacing="0" width="100%" border="0">
                          <tbody>
                            <tr>
                              <td style="word-wrap:break-word;font-size:0px;padding:0px 0px 0px 0px;" align="center">
                                <table role="presentation" cellpadding="0"
                                 cellspacing="0" style="border-collapse:collapse;border-spacing:0px;"
                                  align="center" border="0">
                                  <tbody>
                                    <tr>
                                      <td style="width:150px;">
                                        <a href="https://lad24.ru/" target="_blank">
                                          <img alt="https://lad24.ru/" 
                                          title="" height="auto"
                              src="https://topolio.s3-eu-west-1.amazonaws.com/uploads/5acdd088d918a/1523457724.jpg"
                                            style="border:none;border-radius:0px;
                                            display:block;font-size:13px;
                                            outline:none;text-decoration:none;width:100%;height:auto;"
                                            width="150">
                                        </a>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <!--[if mso | IE]>      </td><td style="vertical-align:top;width:198px;">      <![endif]-->
                      <div class="mj-column-per-33 outlook-group-fix" 
                      style="vertical-align:top;display:inline-block;
                      direction:ltr;font-size:13px;text-align:left;width:100%;">
                        <table role="presentation" cellpadding="0" cellspacing="0" width="100%" border="0">
                          <tbody>
                            <tr>
                              <td style="word-wrap:break-word;font-size:0px;padding:0px 4px 0px 4px;" align="left">
                                <div style="cursor:auto;
                                color:#000000;font-family:Ubuntu, Helvetica, Arial, sans-serif;
                                font-size:11px;line-height:22px;text-align:left;">
                                  <p>
                                    <span style="font-size:14px;">
                                      <span style="color: rgb(44, 62, 80);">&#x41C;
                                      &#x44B; &#x430;&#x432;
                                      &#x442;&#x43E;&#x43C;&#x430;
                                      &#x442;&#x438;&#x437;&#x438;&#x440;&#x443;&#x435;&#x43C;
                                        &#x442;&#x43E;&#x440;&#x433;&#x43E;&#x432;
                                        &#x44B;&#x435; &#x442;&#x43E;&#x447;&#x43A;&#x438;
                                        &#x438; &#x440;&#x430;
                                        &#x437;&#x440;&#x430;&#x431;&#x430;&#x442;&#x44B;&#x432;&#x430;&#x435;&#x43C;
                                        &#x43F;&#x440;&#x438;
                                        &#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x438;&#x44F; &#x434;&#x43B;&#x44F;
                                        &#x431;&#x438;&#x437;&#x43D;&#x435;&#x441;&#x430;.</span>
                                    </span>
                                  </p>
                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <!--[if mso | IE]>      </td><td style="vertical-align:top;width:198px;">      <![endif]-->
                      <div class="mj-column-per-33 outlook-group-fix" 
                      style="vertical-align:top;display:inline-block;direction:ltr;
                      font-size:13px;text-align:left;width:100%;">
                        <table role="presentation" cellpadding="0" cellspacing="0" width="100%" border="0">
                          <tbody>
                            <tr>
                              <td style="word-wrap:break-word;font-size:0px;padding:20px 2px 20px 2px;" align="center">
                                <div style="cursor:auto;color:#000000;
                                font-family:Ubuntu, Helvetica, Arial, sans-serif;
                                font-size:11px;line-height:22px;text-align:center;">
                                  <p>
                                    <span style="color:#e74c3c;">
                                      <span style="font-size: 22px;">kkt365.ru</span>
                                    </span>
                                  </p>
                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
                    </td>
                  </tr>
                </tbody>
              </table>
              <!--[if mso | IE]>        </v:textbox>      </v:rect>      <![endif]-->
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
    <!--[if mso | IE]>      <table role="presentation" border="0" 
    cellpadding="0" cellspacing="0" width="600" align="center" 
    style="width:600px;">        <tr>          <td style="line-height:0px;
    font-size:0px;mso-line-height-rule:exactly;">      <![endif]-->
    <div style="margin:0px auto;max-width:600px;">
      <table role="presentation" cellpadding="0" cellspacing="0" 
      style="font-size:0px;width:100%;" align="center" border="0">
        <tbody>
          <tr>
            <td style="text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;">
              <!--[if mso | IE]>      <table role="presentation" 
              border="0" cellpadding="0" cellspacing="0">        
              <tr>          <td style="vertical-align:top;width:600px;">      <![endif]-->
              <div class="mj-column-per-100 outlook-group-fix" 
              style="vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;">
                <table role="presentation" cellpadding="0" cellspacing="0" width="100%" border="0">
                  <tbody>
                    <tr>
                      <td style="word-wrap:break-word;font-size:0px;">
                        <div style="font-size:1px;line-height:22px;white-space:nowrap;">&#xA0;</div>
                      </td>
                    </tr>
                    <tr>
                      <td style="word-wrap:break-word;font-size:0px;padding:0px 20px 0px 20px;" align="left">
                        <div style="cursor:auto;color:#000000;
                        font-family:Ubuntu, Helvetica, Arial, sans-serif;
                        font-size:11px;line-height:22px;text-align:left;">
                          <p>
                            <span style="font-size:14px;">
                              <span style="color: rgb(44, 62, 80);">
                              &#x417;&#x434;&#x440;&#x430;&#x432;&#x441;
                              &#x442;&#x432;&#x443;&#x439;&#x442;&#x435;!</span>
                            </span>
                          </p>
                          <p>
                            <span style="font-size:14px;">
                              <span style="color: rgb(44, 62, 80);">
                              <%=client.client%>, &#x41F;&#x440;
                              &#x43E;&#x448;&#x443; &#x432;&#x430;&#x441;
                               &#x43E;&#x431;&#x440;&#x430;&#x442;&#x438;&#x442;&#x44C;
                                &#x432;&#x43D;&#x438;&#x43C;&#x430;
                                &#x43D;&#x438;&#x435; &#x43D;&#x430; &#x43D;&#x430;&#x448;&#x435;
                                &#x43A;&#x43E;&#x43C;&#x43C;&#x435;
                                &#x440;&#x447;&#x435;&#x441;&#x43A;
                                &#x43E;&#x435; &#x43F;&#x440;&#x435;
                                &#x434;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x438;&#x435;.
                                &#x41E;&#x43D;&#x43E; &#x434;&#x43E;
                                &#x43B;&#x436;&#x43D;&#x43E; &#x438;&#x434;&#x435;&#x430;&#x43B;&#x44C;&#x43D;&#x43E;
                                &#x43F;&#x43E;&#x434;&#x43E;&#x439;
                                &#x442;&#x438; &#x434;&#x43B;&#x44F; &#x432;&#x430;&#x448;&#x435;&#x439;
                                &#x444;&#x435;&#x440;&#x43C;&#x435;
                                &#x440;&#x441;&#x43A;&#x43E;&#x439; &#x43B;&#x430;&#x432;&#x43A;&#x438;.</span>
                            </span>
                          </p>
                        </div>
                      </td>
                    </tr>
                    <tr>
                      <td style="word-wrap:break-word;font-size:0px;
                      padding:10px 25px;padding-top:10px;padding-bottom:10px;padding-right:16px;padding-left:16px;">
                        <p style="font-size:1px;margin:0px auto;border-top:1px solid #D3CFCF;width:100%;"></p>
                        <!--[if mso | IE]><table role="presentation"
                         align="center" border="0" cellpadding="0" 
                         cellspacing="0" style="font-size:1px;margin:0px auto;
                         border-top:1px solid #D3CFCF;width:100%;" width="600">
                         <tr><td style="height:0;line-height:0;"> </td></tr></table><![endif]-->
                      </td>
                    </tr>
                    <tr>
                      <td style="word-wrap:break-word;font-size:0px;padding:0px 20px 0px 20px;" align="left">
                        <div style="cursor:auto;color:#000000;
                        font-family:Ubuntu, Helvetica, Arial, sans-serif;
                        font-size:11px;line-height:22px;text-align:left;">
                        <% products.forEach(function(product) { %>
                          <table align="left" border="0" cellpadding="0" 
                          cellspacing="0" height="81" id="template__products"
                            width="531">
                            <tbody>
                              <tr>
                                <td><img src='<%=product.img%>' alt='producr img' style='width:100px'></td>
                                <td>
                                  <table align="left" 
                                  border="0" cellpadding="1" cellspacing="5" height="77" width="263">
                                    <tbody>
                                      <tr>
                                        <td>
                                          <span style="font-size:18px;"><%=product.title%></span>
                                        </td>
                                      </tr>
                                      <tr>
                                        <td>
                                          <span style="color:#999999;">
                                            <span style="font-size: 14px;"><%=product.desc%></span>
                                          </span>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </td>
                                <td>
                                  <table align='right' 
                                  border="0" cellpadding="1" cellspacing="1" height="50" width="183">
                                    <tbody>
                                      <tr>
                                        <td rowspan="2">
                                          <span style="font-size:16px;">
                                          <%=product.count%> X <%=product.price%></span>
                                          <span style="color:#999999;">
                                            <span style="font-size: 14px;"><%=product.mouth%></span>
                                          </span>
                                        </td>
                                      </tr>
                                      <tr> </tr>
                                    </tbody>
                                  </table>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                          <% }); %>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
    <!--[if mso | IE]>      <table role="presentation" border="0"
     cellpadding="0" cellspacing="0" width="600" align="center" 
     style="width:600px;">        <tr>          <td style="line-height:0px;font-size:0px;
     mso-line-height-rule:exactly;">      <![endif]-->
    <table role="presentation" cellpadding="0" cellspacing="0" style="font-size:0px;width:100%;" border="0">
      <tbody>
        <tr>
          <td>
            <div style="margin:0px auto;max-width:600px;">
              <table role="presentation" cellpadding="0" 
              cellspacing="0" style="font-size:0px;width:100%;" align="center" border="0">
                <tbody>
                  <tr>
                    <td style="text-align:center;vertical-align:top;
                    direction:ltr;font-size:0px;padding:9px 0px 9px 0px;">
                      <!--[if mso | IE]>      <table role="presentation" 
                      border="0" cellpadding="0" cellspacing="0">        
                      <tr>          <td style="vertical-align:top;width:600px;">      <![endif]-->
                      <div class="mj-column-per-100 outlook-group-fix" 
                      style="vertical-align:top;display:inline-block;
                      direction:ltr;font-size:13px;text-align:left;width:100%;">
                        <table role="presentation" cellpadding="0" cellspacing="0" width="100%" border="0">
                          <tbody>
                            <tr>
                              <td style="word-wrap:break-word;font-size:0px;
                              padding:10px 25px;padding-top:10px;padding-bottom:10px;
                              padding-right:70px;padding-left:70px;">
                                <p style="font-size:1px;margin:0px auto;border-top:1px solid #E4DFDF;width:100%;"></p>
                                <!--[if mso | IE]><table role="presentation" 
                                align="center" border="0" cellpadding="0" 
                                cellspacing="0" style="font-size:1px;
                                margin:0px auto;border-top:1px solid #E4DFDF;width:100%;
                                " width="600"><tr><td style="height:0;line-height:0;"> </td></tr></table><![endif]-->
                              </td>
                            </tr>
                            <tr>
                              <td style="word-wrap:break-word;font-size:0px;padding:0px 20px 0px 20px;" align="left">
                                <div style="cursor:auto;color:#000000;
                                font-family:Ubuntu, Helvetica, Arial, sans-serif;
                                font-size:11px;line-height:22px;text-align:left;">
                                  <table align="right" border="0" cellpadding="1" 
                                  cellspacing="1" height="25" width="214">
                                    <tbody>
                                      <tr>
                                        <td>
                                          <span style="color:#999999;">
                                            <span style="font-size: 20px;">&#x418;&#x442;&#x43E;&#x433;&#x43E;: </span>
                                          </span>
                                        </td>
                                        <td>
                                          <span style="font-size:18px;"><%=totalPrice%></span>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
    <!--[if mso | IE]>      <table role="presentation" border="0" 
    cellpadding="0" cellspacing="0" width="600" align="center" 
    style="width:600px;">        <tr>          <td style="line-height:0px;
    font-size:0px;mso-line-height-rule:exactly;">      <![endif]-->
    <div style="margin:0px auto;max-width:600px;background:#FF7D2A;">
      <table role="presentation" cellpadding="0" cellspacing="0" 
      style="font-size:0px;width:100%;background:#FF7D2A;" align="center"
        border="0">
        <tbody>
          <tr>
            <td style="text-align:center;vertical-align:top;direction:ltr;font-size:0px;padding:9px 0px 9px 0px;">
              <!--[if mso | IE]>      <table role="presentation" 
              border="0" cellpadding="0" cellspacing="0">        
              <tr>          <td style="vertical-align:top;width:600px;">      <![endif]-->
              <div class="mj-column-per-100 outlook-group-fix" 
              style="vertical-align:top;display:inline-block;direction:ltr;font-size:13px;text-align:left;width:100%;">
                <table role="presentation" cellpadding="0" cellspacing="0" width="100%" border="0">
                  <tbody>
                    <tr>
                      <td style="word-wrap:break-word;font-size:0px;padding:0px 20px 0px 20px;" align="center">
                        <div style="cursor:auto;color:#000000;
                        font-family:Ubuntu, Helvetica, Arial, sans-serif;
                        font-size:11px;line-height:22px;text-align:center;">
                          <p>
                            <span style="font-size:16px;">
                              <strong>
                                <span style="color: rgb(236, 240, 241);">
                                &#x41A;&#x443;&#x43F;&#x438;&#x442;&#x435; 
                                &#x432; &#x440;&#x430;&#x441;&#x441;&#x440;&#x43E;&#x447;&#x43A;&#x443;
                                  0-0-6 &#x438;&#x43B;&#x438; &#x43F;&#x43E;
                                  &#x43B;&#x443;&#x447;&#x438;&#x442;&#x435;
                                   &#x441;&#x435;&#x440;&#x442;&#x438;&#x444;&#x438;&#x43A;&#x430;&#x442;
                                  &#x43D;&#x430; 5000.</span>
                              </strong>
                            </span>
                          </p>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
    <!--[if mso | IE]>      <table role="presentation" border="0" 
    cellpadding="0" cellspacing="0" width="600" align="center" 
    style="width:600px;">        <tr>          <td style="line-height:0px;
    font-size:0px;mso-line-height-rule:exactly;">      <![endif]-->
    <table role="presentation" cellpadding="0" cellspacing="0" style="font-size:0px;width:100%;" border="0">
      <tbody>
        <tr>
          <td>
            <div style="margin:0px auto;max-width:600px;">
              <table role="presentation" cellpadding="0" cellspacing="0" 
              style="font-size:0px;width:100%;" align="center" border="0">
                <tbody>
                  <tr>
                    <td style="text-align:center;vertical-align:top;
                    direction:ltr;font-size:0px;padding:9px 0px 9px 0px;">
                      <!--[if mso | IE]>      <table role="presentation"
                       border="0" cellpadding="0" cellspacing="0">        
                       <tr>          <td style="vertical-align:top;width:360px;">      <![endif]-->
                      <div class="mj-column-per-60 outlook-group-fix" 
                      style="vertical-align:top;display:inline-block;
                      direction:ltr;font-size:13px;text-align:left;width:100%;">
                        <table role="presentation" cellpadding="0" cellspacing="0" width="100%" border="0">
                          <tbody>
                            <tr>
                              <td style="word-wrap:break-word;font-size:0px;">
                                <div style="font-size:1px;line-height:18px;white-space:nowrap;">&#xA0;</div>
                              </td>
                            </tr>
                            <tr>
                              <td style="word-wrap:break-word;font-size:0px;padding:0px 20px 0px 20px;" align="left">
                                <div style="cursor:auto;color:#000000;
                                font-family:Ubuntu, Helvetica, Arial, sans-serif;
                                font-size:11px;line-height:22px;text-align:left;">
                                  <table border="0" cellpadding="1" cellspacing="1" style="width: 300px;">
                                    <tbody>
                                      <tr>
                                        <td><%=author.authorName%></td>
                                      </tr>
                                      <tr>
                                        <td>
                                          <table border="0" cellpadding="1" cellspacing="1" height="65" width="292">
                                            <tbody>
                                              <tr>
                                                <td><%=author.authorTel%></td>
                                                <td>
                                                  <span style="font-size:14px;">8 800 775 85 25</span>
                                                </td>
                                              </tr>
                                              <tr>
                                                <td><%=author.authorEmail%></td>
                                                <td>
                                                  <span style="font-size:14px;">www.kkt365.ru</span>
                                                </td>
                                              </tr>
                                            </tbody>
                                          </table>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                  <p></p>
                                </div>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <!--[if mso | IE]>      </td><td style="vertical-align:top;width:240px;">      <![endif]-->
                      <div class="mj-column-per-40 outlook-group-fix" 
                      style="vertical-align:top;display:inline-block;
                      direction:ltr;font-size:13px;text-align:left;width:100%;">
                        <table role="presentation" cellpadding="0" cellspacing="0" width="100%" border="0">
                          <tbody>
                            <tr>
                              <td style="word-wrap:break-word;font-size:0px;padding:1px 1px 1px 1px;" align="center">
                                <table role="presentation" cellpadding="0" 
                                cellspacing="0" style="border-collapse:collapse;border-spacing:0px;"
                                  align="center" border="0">
                                  <tbody>
                                    <tr>
                                      <td style="width:238px;">
                                        <img alt="" title="" height="auto" 
                                  src="https://topolio.s3-eu-west-1.amazonaws.com/uploads/5acdd088d918a/1523457570.jpg"
                                          style="border:none;border-radius:0px;
                               display:block;font-size:13px;outline:none;text-decoration:none;width:100%;height:auto;"
                                          width="238">
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <!--[if mso | IE]>      </td></tr></table>      <![endif]-->
  </div>
</body>

</html>
`;
// <% products.forEach(function(product) { %>
//   <% }); %>
function findElems(findElem: string, options: any) {
  let returnArr: any = [];
  if (options) {
  options.forEach((element: any) => {
    if (element.key === findElem) {
      if (element.type === 'array') {
        element.elements.forEach((elem: any) => {
          let returnObj: any = {};
          if (elem.type === 'array') {
          elem.elements.forEach((element: any) => {
            if (element.elem) {
              returnObj = Object.assign({
                [ element.elem ]: element.value
              }, returnObj);
            }            
          });
        } 
          returnArr.push(returnObj);
        });
        return returnArr;
      }
    } else {
      return [];
    }
  });
  }
  return returnArr;
}
function findObj(findElem: string, options: any) {
  let returnObj = {};
  if (options) {
    options.forEach((element: any) => {
      if (element.key === findElem) {
        if (element.type === 'array') {
            element.elements.forEach((element: any) => {
              if (element.elem) {
                returnObj = Object.assign({
                  [ element.elem ]: element.value
                }, returnObj);
              }            
            });
          return returnObj;
        } else {
          if (element.elem) {
            returnObj = Object.assign({
              [ element.elem ]: element.value
            }, returnObj);
            console.log(returnObj);
          }
        }
      } else {
        return returnObj;
      }
      return returnObj;
    });
    }
  return returnObj;
}

function sumTotalPrice(products: any) {
  let returnPrice = 0;
  products.forEach((element: any) => {
    if (element.price) {
      element.price = parseInt(element.price, 10);
      if (element.price < 0) {
        element.price = 0;
      }
    } else {
      element.price = 0;
    }
    if (element.count) {
      element.count = parseInt(element.count, 10);
      if (element.count < 0) {
        element.count = 0;
      }
    } else {
      element.count = 0;
    }
    returnPrice += element.price * element.count;
  });
  console.log(returnPrice);
  return returnPrice;
}

function compile(options: any) {

  const products = findElems('template1__products', options);
  const totalPrice: number = sumTotalPrice(products);
  const author: any = findObj('author', options);
  const client: any = findObj('client', options);
  const compiledTemplate: string = _.template(tpl)({
    products: products,
    totalPrice: totalPrice,
    author: author,
    client: client
  });
  return compiledTemplate;
}

export default (state: any) => {
  const options = state.params.options;
  const final = compile(options);
  return final;
};